<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orçamentos - AutoFlow</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/dashboard.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <!-- Bibliotecas para PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Menu Manager -->
    <script src="../js/menu-manager.js"></script>
</head>

<body>
    <div class="container">
        <header class="main-header">
            <div class="logo" style="display: flex; align-items: center; gap: 20px;">
                <img src="../img/logo.png" alt="AutoFlow Logo"
                    style="height: 100px; width: auto; max-width: 400px; object-fit: contain;"
                    onerror="this.style.display='none'">
            </div>
            <nav class="main-nav" id="main-nav-container">
                <!-- Menu será carregado dinamicamente baseado no plano -->
            </nav>
            <div class="user-info" id="user-info"></div>
        </header>

        <main class="main-content">
            <div class="dashboard-section">
                <div class="section-header">
                    <h2>Orçamentos</h2>
                    <button id="btn-novo-orcamento" class="btn btn-success">+ Novo Orçamento</button>
                </div>

                <!-- Filtros -->
                <div class="filters-bar">
                    <div class="search-box">
                        <input type="text" id="search-orcamento" placeholder="Buscar por número ou cliente...">
                    </div>
                    <div class="filter-options">
                        <select id="filter-status">
                            <option value="">Todos os status</option>
                            <option value="pendente">Pendente</option>
                            <option value="aprovado">Aprovado</option>
                            <option value="recusado">Recusado</option>
                            <option value="pago">Pago</option>
                            <option value="concluido">Concluído</option>
                        </select>
                    </div>
                </div>

                <div class="table-container">
                    <table class="data-table" id="orcamentos-table">
                        <thead>
                            <tr>
                                <th>Número</th>
                                <th>Cliente</th>
                                <th>Veículo</th>
                                <th>Valor</th>
                                <th>Status</th>
                                <th>Data</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="orcamentos-body">
                            <tr>
                                <td colspan="7" class="text-center">Carregando...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="loader" id="orcamentos-loader"></div>

                <!-- Paginação -->
                <div class="pagination" id="pagination">
                    <button class="btn-pagination" id="prev-page" disabled>Anterior</button>
                    <span class="page-info" id="page-info">Página 1</span>
                    <button class="btn-pagination" id="next-page">Próxima</button>
                </div>
            </div>
        </main>

        <footer class="main-footer">
            <p>&copy; 2026 AutoFlow. Todos os direitos reservados.</p>
        </footer>
    </div>

    <!-- Modal para novo orçamento -->
    <div id="orcamento-modal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-title-orcamento">Novo Orçamento</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="form-orcamento">
                    <div class="form-group">
                        <label for="orcamento-numero">Número do Orçamento</label>
                        <input type="text" id="orcamento-numero" class="form-control"
                            placeholder="Gerado automaticamente" readonly>
                    </div>

                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="orcamento-cliente">Cliente *</label>
                            <select id="orcamento-cliente" class="form-control" required>
                                <option value="">Carregando clientes...</option>
                            </select>
                        </div>

                        <div class="form-group col-md-6">
                            <label for="orcamento-veiculo">Veículo *</label>
                            <select id="orcamento-veiculo" class="form-control" required>
                                <option value="">Carregando veículos...</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group col-md-4">
                            <label for="orcamento-status">Status</label>
                            <select id="orcamento-status" class="form-control">
                                <option value="pendente">Pendente</option>
                                <option value="aprovado">Aprovado</option>
                                <option value="recusado">Recusado</option>
                                <option value="pago">Pago</option>
                                <option value="concluido">Concluído</option>
                            </select>
                        </div>

                        <div class="form-group col-md-4">
                            <label for="orcamento-validade">Validade (dias)</label>
                            <input type="number" id="orcamento-validade" class="form-control" value="7" min="1">
                        </div>

                        <div class="form-group col-md-4">
                            <label for="orcamento-data">Data</label>
                            <input type="date" id="orcamento-data" class="form-control">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="orcamento-descricao">Descrição do Serviço</label>
                        <textarea id="orcamento-descricao" class="form-control" rows="3"
                            placeholder="Descreva os serviços a serem realizados"></textarea>
                    </div>

                    <div class="form-group">
                        <label>Itens do Orçamento</label>
                        <div id="orcamento-itens">
                            <div class="item-orcamento">
                                <input type="text" class="item-descricao form-control" placeholder="Descrição do item">
                                <input type="number" class="item-quantidade form-control" placeholder="Qtd" min="1"
                                    value="1" style="width: 80px;">
                                <input type="number" class="item-valor form-control" placeholder="Valor unit."
                                    step="0.01" min="0" style="width: 120px;">
                                <button type="button" class="btn btn-sm btn-danger remover-item">×</button>
                            </div>
                        </div>
                        <button type="button" id="btn-add-item" class="btn btn-sm btn-secondary"
                            style="margin-top: 10px;">+ Adicionar Item</button>
                    </div>

                    <div class="form-group" style="text-align: right;">
                        <label>Total: <span id="orcamento-total" style="font-weight: bold; color: #c62828;">R$
                                0,00</span></label>
                    </div>

                    <div class="form-group">
                        <label for="orcamento-observacoes">Observações</label>
                        <textarea id="orcamento-observacoes" class="form-control" rows="3"></textarea>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary" id="btn-salvar-orcamento">Salvar
                            Orçamento</button>
                        <button type="button" class="btn btn-secondary modal-close">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para visualizar orçamento -->
    <div id="view-orcamento-modal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title">Detalhes do Orçamento</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body" id="orcamento-detalhes-container">
                <!-- Conteúdo carregado via JavaScript -->
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-success" id="btn-pdf-detalhe">Gerar PDF</button>
                <button type="button" class="btn btn-secondary modal-close">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal para alterar status -->
    <div id="status-modal" class="modal">
        <div class="modal-content" style="max-width: 350px;">
            <div class="modal-header">
                <h2>Alterar Status</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="novo-status">Novo Status</label>
                    <select id="novo-status" class="form-control">
                        <option value="pendente">Pendente</option>
                        <option value="aprovado">Aprovado</option>
                        <option value="recusado">Recusado</option>
                        <option value="pago">Pago</option>
                        <option value="concluido">Concluído</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button id="btn-confirmar-status" class="btn btn-primary">Confirmar</button>
                    <button class="btn btn-secondary modal-close">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/firebase-config.js"></script>
    <script src="../js/verificar-plano.js"></script>

    <script>
        // ===========================================
        // VARIÁVEIS GLOBAIS
        // ===========================================
        let todosOrcamentos = [];
        let orcamentosFiltrados = [];
        let paginaAtual = 1;
        let itensPorPagina = 10;
        let orcamentoAtualId = null;
        let carregandoOrcamentos = false;

        // ===========================================
        // INICIALIZAÇÃO
        // ===========================================
        document.addEventListener('DOMContentLoaded', async function () {
            // Verificar permissão da página
            const temPermissao = await window.permissoes.verificarPermissaoPagina();
            if (!temPermissao) return;

            const plano = sessionStorage.getItem('planoAtual') || 'basico';
            const oficinaId = sessionStorage.getItem('oficinaId');

            if (!oficinaId) {
                window.location.href = 'login.html';
                return;
            }

            // Gerar menu baseado no plano
            const navContainer = document.getElementById('main-nav-container');
            let menuHtml = '';

            if (plano === 'basico') {
                menuHtml = `
                    <ul>
                        <li><a href="dashboard.html">Dashboard</a></li>
                        <li><a href="orcamentos.html" class="active">Orçamentos</a></li>
                    </ul>
                `;
            } else if (plano === 'intermediario') {
                menuHtml = `
                    <ul>
                        <li><a href="dashboard.html">Dashboard</a></li>
                        <li><a href="clientes.html">Clientes</a></li>
                        <li><a href="veiculos.html">Veículos</a></li>
                        <li><a href="orcamentos.html" class="active">Orçamentos</a></li>
                    </ul>
                `;
            } else if (plano === 'completo') {
                menuHtml = `
                    <ul>
                        <li><a href="dashboard.html">Dashboard</a></li>
                        <li><a href="clientes.html">Clientes</a></li>
                        <li><a href="veiculos.html">Veículos</a></li>
                        <li><a href="orcamentos.html" class="active">Orçamentos</a></li>
                        <li><a href="financeiro.html">Financeiro</a></li>
                    </ul>
                `;
            }

            navContainer.innerHTML = menuHtml;



            // Verificar autenticação
            auth.onAuthStateChanged(function (user) {
                if (user) {
                    loadUserInfo(user);
                    loadOrcamentos();
                    carregarClientesParaSelect();
                    carregarVeiculosParaSelect();
                } else {
                    window.location.href = 'login.html';
                }
            });

            // Configurar eventos
            document.getElementById('btn-novo-orcamento').addEventListener('click', showNovoOrcamentoForm);
            document.getElementById('search-orcamento')?.addEventListener('input', filtrarOrcamentos);
            document.getElementById('filter-status')?.addEventListener('change', filtrarOrcamentos);

            // Fechar modais
            document.querySelectorAll('.modal-close').forEach(btn => {
                btn.addEventListener('click', function () {
                    document.getElementById('orcamento-modal').classList.remove('active');
                    document.getElementById('view-orcamento-modal').classList.remove('active');
                    document.getElementById('status-modal').classList.remove('active');
                });
            });

            // Configurar data atual
            setDefaultDate();

            // Adicionar estilos
            adicionarEstilosOrcamento();
        });

        // ===========================================
        // FUNÇÕES AUXILIARES
        // ===========================================
        function loadUserInfo(user) {
            const userInfo = document.getElementById('user-info');
            if (userInfo) {
                userInfo.innerHTML = `
                    <span class="user-email">${user.email}</span>
                    <button id="logout-btn" class="btn btn-sm btn-danger">Sair</button>
                `;

                document.getElementById('logout-btn').addEventListener('click', function () {
                    auth.signOut().then(() => {
                        window.location.href = 'login.html';
                    });
                });
            }
        }

        function setDefaultDate() {
            const hoje = new Date();
            const ano = hoje.getFullYear();
            const mes = String(hoje.getMonth() + 1).padStart(2, '0');
            const dia = String(hoje.getDate()).padStart(2, '0');
            document.getElementById('orcamento-data').value = `${ano}-${mes}-${dia}`;
        }

        function criarModal() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            document.body.appendChild(modal);
            return modal;
        }

        // ===========================================
        // CARREGAR CLIENTES PARA SELECT
        // ===========================================
        function carregarClientesParaSelect() {
            const oficinaId = sessionStorage.getItem('oficinaId');
            const selectCliente = document.getElementById('orcamento-cliente');

            if (!selectCliente) return;

            db.collection('oficinas').doc(oficinaId).collection('clientes').orderBy('nome').get()
                .then((snapshot) => {
                    selectCliente.innerHTML = '<option value="">Selecione um cliente</option>';
                    snapshot.forEach((doc) => {
                        const cliente = doc.data();
                        const option = document.createElement('option');
                        option.value = doc.id;
                        option.textContent = cliente.nome;
                        selectCliente.appendChild(option);
                    });
                })
                .catch((error) => {
                    console.error('Erro ao carregar clientes:', error);
                    selectCliente.innerHTML = '<option value="">Erro ao carregar clientes</option>';
                });
        }

        // ===========================================
        // CARREGAR VEÍCULOS PARA SELECT
        // ===========================================
        function carregarVeiculosParaSelect() {
            const oficinaId = sessionStorage.getItem('oficinaId');
            const selectVeiculo = document.getElementById('orcamento-veiculo');

            if (!selectVeiculo) return;

            db.collection('oficinas').doc(oficinaId).collection('veiculos').orderBy('placa').get()
                .then((snapshot) => {
                    selectVeiculo.innerHTML = '<option value="">Selecione um veículo</option>';
                    snapshot.forEach((doc) => {
                        const veiculo = doc.data();
                        const option = document.createElement('option');
                        option.value = doc.id;
                        option.textContent = `${veiculo.placa || 'SEM PLACA'} - ${veiculo.marca} ${veiculo.modelo}`;
                        selectVeiculo.appendChild(option);
                    });
                })
                .catch((error) => {
                    console.error('Erro ao carregar veículos:', error);
                    selectVeiculo.innerHTML = '<option value="">Erro ao carregar veículos</option>';
                });
        }

        // ===========================================
        // CARREGAR ORÇAMENTOS
        // ===========================================
        function loadOrcamentos() {
            if (carregandoOrcamentos) return;

            const loader = document.getElementById('orcamentos-loader');
            const orcamentosBody = document.getElementById('orcamentos-body');
            const oficinaId = sessionStorage.getItem('oficinaId');

            if (!oficinaId) {
                console.error('ID da oficina não encontrado');
                return;
            }

            carregandoOrcamentos = true;

            if (loader) loader.style.display = 'block';
            if (orcamentosBody) orcamentosBody.innerHTML = '<tr><td colspan="7" class="text-center">Carregando...</td></tr>';

            db.collection('oficinas').doc(oficinaId).collection('orcamentos')
                .orderBy('data', 'desc')
                .get()
                .then((snapshot) => {
                    carregandoOrcamentos = false;
                    if (loader) loader.style.display = 'none';

                    if (!orcamentosBody) return;

                    if (snapshot.empty) {
                        orcamentosBody.innerHTML = `
                            <tr>
                                <td colspan="7" class="text-center">
                                    Nenhum orçamento cadastrado.<br>
                                    <button onclick="showNovoOrcamentoForm()" class="btn btn-sm btn-primary" style="margin-top: 10px;">
                                        + Criar Primeiro Orçamento
                                    </button>
                                </td>
                            </tr>
                        `;
                        return;
                    }

                    // Carregar clientes e veículos para os nomes
                    Promise.all([
                        db.collection('oficinas').doc(oficinaId).collection('clientes').get(),
                        db.collection('oficinas').doc(oficinaId).collection('veiculos').get()
                    ])
                        .then(([clientesSnapshot, veiculosSnapshot]) => {
                            const clientesMap = {};
                            clientesSnapshot.forEach(doc => {
                                clientesMap[doc.id] = doc.data().nome;
                            });

                            const veiculosMap = {};
                            veiculosSnapshot.forEach(doc => {
                                const veiculo = doc.data();
                                veiculosMap[doc.id] = `${veiculo.marca} ${veiculo.modelo} (${veiculo.placa || 'SEM PLACA'})`;
                            });

                            todosOrcamentos = [];
                            snapshot.forEach(doc => {
                                const orcamento = doc.data();
                                const dataFormatada = orcamento.data ? new Date(orcamento.data).toLocaleDateString('pt-BR') : '-';

                                todosOrcamentos.push({
                                    id: doc.id,
                                    numero: orcamento.numero,
                                    clienteId: orcamento.clienteId,
                                    clienteNome: clientesMap[orcamento.clienteId] || 'Cliente não encontrado',
                                    veiculoId: orcamento.veiculoId,
                                    veiculoDesc: veiculosMap[orcamento.veiculoId] || 'Veículo não encontrado',
                                    valorTotal: orcamento.valorTotal || 0,
                                    status: orcamento.status || 'pendente',
                                    data: dataFormatada,
                                    dataOriginal: orcamento.data
                                });
                            });

                            orcamentosFiltrados = [...todosOrcamentos];
                            renderizarTabelaOrcamentos();
                            configurarPaginacao();
                        });
                })
                .catch((error) => {
                    carregandoOrcamentos = false;
                    console.error('Erro ao carregar orçamentos:', error);
                    if (loader) loader.style.display = 'none';
                    if (orcamentosBody) {
                        orcamentosBody.innerHTML = `
                            <tr>
                                <td colspan="7" class="text-center">Erro ao carregar orçamentos.</td>
                            </tr>
                        `;
                    }
                });
        }

        // ===========================================
        // RENDERIZAR TABELA
        // ===========================================
        function renderizarTabelaOrcamentos() {
            const orcamentosBody = document.getElementById('orcamentos-body');

            const inicio = (paginaAtual - 1) * itensPorPagina;
            const fim = inicio + itensPorPagina;
            const paginaData = orcamentosFiltrados.slice(inicio, fim);

            if (!orcamentosBody) return;

            orcamentosBody.innerHTML = '';

            if (paginaData.length === 0) {
                orcamentosBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center">Nenhum orçamento encontrado.</td>
                    </tr>
                `;
                return;
            }

            paginaData.forEach((orcamento) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${orcamento.numero || 'N/A'}</strong></td>
                    <td>${orcamento.clienteNome}</td>
                    <td>${orcamento.veiculoDesc}</td>
                    <td>R$ ${orcamento.valorTotal.toFixed(2)}</td>
                    <td><span class="status-badge status-${orcamento.status}">${getStatusText(orcamento.status)}</span></td>
                    <td>${orcamento.data}</td>
                    <td class="actions">
                        <button class="btn btn-sm btn-info" onclick="visualizarOrcamento('${orcamento.id}')">Ver</button>
                        <button class="btn btn-sm btn-success" onclick="gerarPDF('${orcamento.id}')">PDF</button>
                        <button class="btn btn-sm btn-warning" onclick="abrirModalStatus('${orcamento.id}')">Status</button>
                        <button class="btn btn-sm btn-danger" onclick="excluirOrcamento('${orcamento.id}')">Excluir</button>
                    </td>
                `;
                orcamentosBody.appendChild(row);
            });

            const totalPaginas = Math.ceil(orcamentosFiltrados.length / itensPorPagina);
            document.getElementById('page-info').textContent = `Página ${paginaAtual} de ${totalPaginas || 1}`;
            document.getElementById('prev-page').disabled = paginaAtual === 1;
            document.getElementById('next-page').disabled = paginaAtual === totalPaginas || totalPaginas === 0;
        }

        // ===========================================
        // FILTRAR ORÇAMENTOS
        // ===========================================
        function filtrarOrcamentos() {
            const termoBusca = document.getElementById('search-orcamento')?.value.toLowerCase() || '';
            const statusFiltro = document.getElementById('filter-status')?.value || '';

            orcamentosFiltrados = todosOrcamentos.filter(orc => {
                const matchBusca = !termoBusca ||
                    (orc.numero && orc.numero.toLowerCase().includes(termoBusca)) ||
                    (orc.clienteNome && orc.clienteNome.toLowerCase().includes(termoBusca));

                const matchStatus = !statusFiltro || orc.status === statusFiltro;

                return matchBusca && matchStatus;
            });

            paginaAtual = 1;
            renderizarTabelaOrcamentos();
        }

        // ===========================================
        // CONFIGURAR PAGINAÇÃO
        // ===========================================
        function configurarPaginacao() {
            const prevBtn = document.getElementById('prev-page');
            const nextBtn = document.getElementById('next-page');

            const newPrevBtn = prevBtn.cloneNode(true);
            const newNextBtn = nextBtn.cloneNode(true);
            prevBtn.parentNode.replaceChild(newPrevBtn, prevBtn);
            nextBtn.parentNode.replaceChild(newNextBtn, nextBtn);

            newPrevBtn.addEventListener('click', () => {
                if (paginaAtual > 1) {
                    paginaAtual--;
                    renderizarTabelaOrcamentos();
                }
            });

            newNextBtn.addEventListener('click', () => {
                const totalPaginas = Math.ceil(orcamentosFiltrados.length / itensPorPagina);
                if (paginaAtual < totalPaginas) {
                    paginaAtual++;
                    renderizarTabelaOrcamentos();
                }
            });
        }

        // ===========================================
        // UTILITÁRIOS DE STATUS
        // ===========================================
        function getStatusText(status) {
            const statusMap = {
                'pendente': 'Pendente',
                'aprovado': 'Aprovado',
                'recusado': 'Recusado',
                'pago': 'Pago',
                'concluido': 'Concluído'
            };
            return statusMap[status] || 'Pendente';
        }

        // ===========================================
        // NOVO ORÇAMENTO
        // ===========================================
        function showNovoOrcamentoForm() {
            orcamentoAtualId = null;
            document.getElementById('modal-title-orcamento').textContent = 'Novo Orçamento';
            document.getElementById('btn-salvar-orcamento').textContent = 'Salvar Orçamento';

            // Limpar formulário
            document.getElementById('form-orcamento').reset();
            document.getElementById('orcamento-itens').innerHTML = `
                <div class="item-orcamento">
                    <input type="text" class="item-descricao form-control" placeholder="Descrição do item">
                    <input type="number" class="item-quantidade form-control" placeholder="Qtd" min="1" value="1" style="width: 80px;">
                    <input type="number" class="item-valor form-control" placeholder="Valor unit." step="0.01" min="0" style="width: 120px;">
                    <button type="button" class="btn btn-sm btn-danger remover-item">×</button>
                </div>
            `;

            gerarNumeroOrcamento();
            setDefaultDate();
            carregarClientesParaSelect();
            carregarVeiculosParaSelect();

            document.getElementById('orcamento-modal').classList.add('active');
        }

        // ===========================================
        // GERAR NÚMERO DO ORÇAMENTO
        // ===========================================
        function gerarNumeroOrcamento() {
            const oficinaId = sessionStorage.getItem('oficinaId');
            const ano = new Date().getFullYear();

            db.collection('oficinas').doc(oficinaId).collection('orcamentos')
                .orderBy('numero', 'desc')
                .limit(1)
                .get()
                .then((snapshot) => {
                    let proximoNumero = 1;

                    if (!snapshot.empty) {
                        const ultimoOrcamento = snapshot.docs[0].data();
                        const ultimoNumero = ultimoOrcamento.numero || '';
                        const partes = ultimoNumero.split('-');
                        if (partes.length === 3 && partes[2]) {
                            const num = parseInt(partes[2]);
                            if (!isNaN(num)) {
                                proximoNumero = num + 1;
                            }
                        }
                    }

                    const numeroFormatado = `ORC-${ano}-${proximoNumero.toString().padStart(4, '0')}`;
                    document.getElementById('orcamento-numero').value = numeroFormatado;
                })
                .catch(() => {
                    document.getElementById('orcamento-numero').value = `ORC-${ano}-0001`;
                });
        }

        // ===========================================
        // ITENS DO ORÇAMENTO
        // ===========================================
        document.getElementById('btn-add-item')?.addEventListener('click', function () {
            const container = document.getElementById('orcamento-itens');
            const item = document.createElement('div');
            item.className = 'item-orcamento';
            item.innerHTML = `
                <input type="text" class="item-descricao form-control" placeholder="Descrição do item">
                <input type="number" class="item-quantidade form-control" placeholder="Qtd" min="1" value="1" style="width: 80px;">
                <input type="number" class="item-valor form-control" placeholder="Valor unit." step="0.01" min="0" style="width: 120px;">
                <button type="button" class="btn btn-sm btn-danger remover-item">×</button>
            `;
            container.appendChild(item);

            // Adicionar evento para calcular total
            item.querySelector('.item-quantidade').addEventListener('input', calcularTotalOrcamento);
            item.querySelector('.item-valor').addEventListener('input', calcularTotalOrcamento);
        });

        document.getElementById('orcamento-itens')?.addEventListener('click', function (e) {
            if (e.target.classList.contains('remover-item')) {
                if (document.querySelectorAll('.item-orcamento').length > 1) {
                    e.target.closest('.item-orcamento').remove();
                    calcularTotalOrcamento();
                } else {
                    alert('Mantenha pelo menos um item');
                }
            }
        });

        document.getElementById('orcamento-itens')?.addEventListener('input', calcularTotalOrcamento);

        function calcularTotalOrcamento() {
            const itens = document.querySelectorAll('.item-orcamento');
            let total = 0;

            itens.forEach(item => {
                const qtd = parseFloat(item.querySelector('.item-quantidade').value) || 0;
                const valor = parseFloat(item.querySelector('.item-valor').value) || 0;
                total += qtd * valor;
            });

            document.getElementById('orcamento-total').textContent = `R$ ${total.toFixed(2)}`;
        }

        // ===========================================
        // SALVAR ORÇAMENTO
        // ===========================================
        document.getElementById('form-orcamento')?.addEventListener('submit', function (e) {
            e.preventDefault();

            const oficinaId = sessionStorage.getItem('oficinaId');

            // Validar cliente e veículo
            if (!document.getElementById('orcamento-cliente').value) {
                alert('Selecione um cliente');
                return;
            }

            if (!document.getElementById('orcamento-veiculo').value) {
                alert('Selecione um veículo');
                return;
            }

            // Coletar itens
            const itens = [];
            document.querySelectorAll('.item-orcamento').forEach(item => {
                const descricao = item.querySelector('.item-descricao').value;
                const qtd = parseFloat(item.querySelector('.item-quantidade').value) || 0;
                const valor = parseFloat(item.querySelector('.item-valor').value) || 0;

                if (descricao && qtd > 0 && valor > 0) {
                    itens.push({
                        descricao: descricao,
                        quantidade: qtd,
                        valorUnitario: valor,
                        total: qtd * valor
                    });
                }
            });

            if (itens.length === 0) {
                alert('Adicione pelo menos um item válido');
                return;
            }

            const orcamentoData = {
                numero: document.getElementById('orcamento-numero').value,
                clienteId: document.getElementById('orcamento-cliente').value,
                veiculoId: document.getElementById('orcamento-veiculo').value,
                status: document.getElementById('orcamento-status').value,
                validade: parseInt(document.getElementById('orcamento-validade').value) || 7,
                descricao: document.getElementById('orcamento-descricao').value,
                itens: itens,
                valorTotal: itens.reduce((acc, item) => acc + item.total, 0),
                observacoes: document.getElementById('orcamento-observacoes').value,
                data: document.getElementById('orcamento-data').value,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            const btnSalvar = document.getElementById('btn-salvar-orcamento');
            const textoOriginal = btnSalvar.textContent;
            btnSalvar.disabled = true;
            btnSalvar.textContent = 'Salvando...';

            if (orcamentoAtualId) {
                // Atualizar orçamento existente
                db.collection('oficinas').doc(oficinaId).collection('orcamentos').doc(orcamentoAtualId).update(orcamentoData)
                    .then(() => {
                        alert('Orçamento atualizado com sucesso!');
                        document.getElementById('orcamento-modal').classList.remove('active');
                        loadOrcamentos();
                    })
                    .catch((error) => {
                        console.error('Erro ao atualizar orçamento:', error);
                        alert('Erro ao atualizar orçamento');
                    })
                    .finally(() => {
                        btnSalvar.disabled = false;
                        btnSalvar.textContent = textoOriginal;
                    });
            } else {
                // Adicionar novo orçamento
                db.collection('oficinas').doc(oficinaId).collection('orcamentos').add(orcamentoData)
                    .then(() => {
                        alert('Orçamento salvo com sucesso!');
                        document.getElementById('orcamento-modal').classList.remove('active');
                        loadOrcamentos();
                    })
                    .catch((error) => {
                        console.error('Erro ao salvar orçamento:', error);
                        alert('Erro ao salvar orçamento');
                    })
                    .finally(() => {
                        btnSalvar.disabled = false;
                        btnSalvar.textContent = textoOriginal;
                    });
            }
        });

        // ===========================================
        // VISUALIZAR ORÇAMENTO
        // ===========================================
        window.visualizarOrcamento = function (id) {
            const oficinaId = sessionStorage.getItem('oficinaId');

            Promise.all([
                db.collection('oficinas').doc(oficinaId).collection('orcamentos').doc(id).get(),
                db.collection('oficinas').doc(oficinaId).collection('clientes').get(),
                db.collection('oficinas').doc(oficinaId).collection('veiculos').get()
            ])
                .then(([orcamentoDoc, clientesSnapshot, veiculosSnapshot]) => {
                    if (!orcamentoDoc.exists) {
                        alert('Orçamento não encontrado');
                        return;
                    }

                    const orcamento = orcamentoDoc.data();

                    const clientesMap = {};
                    clientesSnapshot.forEach(doc => {
                        clientesMap[doc.id] = doc.data();
                    });

                    const veiculosMap = {};
                    veiculosSnapshot.forEach(doc => {
                        veiculosMap[doc.id] = doc.data();
                    });

                    const cliente = clientesMap[orcamento.clienteId] || {};
                    const veiculo = veiculosMap[orcamento.veiculoId] || {};

                    const dataFormatada = orcamento.data ? new Date(orcamento.data).toLocaleDateString('pt-BR') : '-';

                    let html = `
                        <div style="margin-bottom: 20px;">
                            <h3>Orçamento ${orcamento.numero}</h3>
                            <p><strong>Data:</strong> ${dataFormatada}</p>
                            <p><strong>Status:</strong> <span class="status-badge status-${orcamento.status}">${getStatusText(orcamento.status)}</span></p>
                            <p><strong>Validade:</strong> ${orcamento.validade || 7} dias</p>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div style="background: #f8f9fa; padding: 15px; border: 1px solid #e0e0e0;">
                                <h4 style="margin-top: 0;">Cliente</h4>
                                <p><strong>Nome:</strong> ${cliente.nome || '-'}</p>
                                <p><strong>Telefone:</strong> ${cliente.telefone || '-'}</p>
                                <p><strong>Email:</strong> ${cliente.email || '-'}</p>
                            </div>
                            <div style="background: #f8f9fa; padding: 15px; border: 1px solid #e0e0e0;">
                                <h4 style="margin-top: 0;">Veículo</h4>
                                <p><strong>Placa:</strong> ${veiculo.placa || '-'}</p>
                                <p><strong>Marca/Modelo:</strong> ${veiculo.marca || ''} ${veiculo.modelo || ''}</p>
                                <p><strong>Ano:</strong> ${veiculo.ano || '-'}</p>
                            </div>
                        </div>
                        
                        <h4>Itens</h4>
                        <table class="data-table" style="margin-bottom: 20px;">
                            <thead>
                                <tr>
                                    <th>Descrição</th>
                                    <th>Qtd</th>
                                    <th>Valor Unit.</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    if (orcamento.itens && orcamento.itens.length > 0) {
                        orcamento.itens.forEach(item => {
                            html += `
                                <tr>
                                    <td>${item.descricao}</td>
                                    <td>${item.quantidade}</td>
                                    <td>R$ ${item.valorUnitario.toFixed(2)}</td>
                                    <td>R$ ${item.total.toFixed(2)}</td>
                                </tr>
                            `;
                        });
                    }

                    html += `
                            <tr style="font-weight: bold;">
                                <td colspan="3" style="text-align: right;">Total:</td>
                                <td>R$ ${orcamento.valorTotal ? orcamento.valorTotal.toFixed(2) : '0,00'}</td>
                            </tr>
                        </tbody>
                    </table>
                    `;

                    if (orcamento.descricao) {
                        html += `<p><strong>Descrição:</strong> ${orcamento.descricao}</p>`;
                    }

                    if (orcamento.observacoes) {
                        html += `<p><strong>Observações:</strong> ${orcamento.observacoes}</p>`;
                    }

                    document.getElementById('orcamento-detalhes-container').innerHTML = html;

                    // Configurar botão PDF
                    document.getElementById('btn-pdf-detalhe').onclick = () => gerarPDF(id);

                    document.getElementById('view-orcamento-modal').classList.add('active');
                })
                .catch((error) => {
                    console.error('Erro ao carregar orçamento:', error);
                    alert('Erro ao carregar orçamento');
                });
        };

        // ===========================================
        // GERAR PDF
        // ===========================================
        // GERAR PDF - VERSÃO NEUTRA E PROFISSIONAL
        // ===========================================
        // ===========================================
        // GERAR PDF - VERSÃO NEUTRA E PROFISSIONAL
        // ===========================================
        window.gerarPDF = async function (id) {
            const oficinaId = sessionStorage.getItem('oficinaId');
            const oficinaNome = sessionStorage.getItem('oficinaNome') || 'AutoFlow';

            try {
                const docSnap = await db.collection('oficinas').doc(oficinaId).collection('orcamentos').doc(id).get();

                if (!docSnap.exists) {
                    alert('Orçamento não encontrado');
                    return;
                }

                const orc = docSnap.data();

                // Buscar dados completos do cliente e veículo
                let cliente = { nome: 'Não informado', telefone: '', email: '', cpf: '', endereco: '' };
                let veiculo = { placa: '', marca: '', modelo: '', ano: '', cor: '', km: '' };

                if (orc.clienteId) {
                    const clienteDoc = await db.collection('oficinas').doc(oficinaId).collection('clientes').doc(orc.clienteId).get();
                    if (clienteDoc.exists) {
                        cliente = clienteDoc.data();
                    }
                } else if (orc.cliente) {
                    cliente = orc.cliente;
                }

                if (orc.veiculoId) {
                    const veiculoDoc = await db.collection('oficinas').doc(oficinaId).collection('veiculos').doc(orc.veiculoId).get();
                    if (veiculoDoc.exists) {
                        veiculo = veiculoDoc.data();
                    }
                } else if (orc.veiculo) {
                    veiculo = orc.veiculo;
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Configurações de estilo - Paleta NEUTRA
                const pageWidth = doc.internal.pageSize.width;
                const pageHeight = doc.internal.pageSize.height;
                const margin = 20;
                let y = margin;

                // Cores neutras e profissionais
                const darkGray = [60, 60, 60];      // Cinza escuro para títulos
                const mediumGray = [100, 100, 100];  // Cinza médio para subtítulos
                const lightGray = [245, 245, 245];   // Cinza claríssimo para fundos
                const borderGray = [220, 220, 220];  // Cinza para bordas
                const textColor = [80, 80, 80];       // Cinza para texto
                const blackColor = [0, 0, 0];          // Preto para textos importantes

                // ===========================================
                // CABEÇALHO PROFISSIONAL
                // ===========================================

                // Linha superior elegante
                doc.setFillColor(mediumGray[0], mediumGray[1], mediumGray[2]);
                doc.rect(0, 0, pageWidth, 2, 'F');

                y += 15;

                // Nome da oficina/empresa
                doc.setFontSize(22);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(darkGray[0], darkGray[1], darkGray[2]);
                doc.text(oficinaNome.toUpperCase(), pageWidth / 2, y, { align: 'center' });

                y += 10;

                // Título do documento
                doc.setFontSize(16);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(mediumGray[0], mediumGray[1], mediumGray[2]);
                doc.text('ORÇAMENTO DE SERVIÇOS', pageWidth / 2, y, { align: 'center' });

                y += 15;

                // Linha divisória dupla (mais elegante)
                doc.setDrawColor(borderGray[0], borderGray[1], borderGray[2]);
                doc.setLineWidth(0.3);
                doc.line(margin, y, pageWidth - margin, y);

                y += 10;

                // ===========================================
                // NÚMERO E DATA (em caixa)
                // ===========================================

                // Fundo cinza claro para destacar informações principais
                doc.setFillColor(lightGray[0], lightGray[1], lightGray[2]);
                doc.rect(margin, y - 5, pageWidth - (2 * margin), 18, 'F');

                // Número do orçamento
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(blackColor[0], blackColor[1], blackColor[2]);
                doc.text('ORÇAMENTO Nº:', margin + 5, y);

                doc.setFont('helvetica', 'normal');
                doc.setTextColor(textColor[0], textColor[1], textColor[2]);
                doc.text(orc.numero || 'N/A', margin + 45, y);

                // Data
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(blackColor[0], blackColor[1], blackColor[2]);
                doc.text('DATA:', pageWidth - 100, y);

                doc.setFont('helvetica', 'normal');
                doc.setTextColor(textColor[0], textColor[1], textColor[2]);
                const dataFormatada = orc.data ? new Date(orc.data).toLocaleDateString('pt-BR') : '-';
                doc.text(dataFormatada, pageWidth - 75, y);

                y += 20;

                // ===========================================
                // DADOS DO CLIENTE (com bordas elegantes)
                // ===========================================

                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(darkGray[0], darkGray[1], darkGray[2]);
                doc.text('DADOS DO CLIENTE', margin, y);

                y += 8;

                // Caixa com borda para dados do cliente
                doc.setDrawColor(borderGray[0], borderGray[1], borderGray[2]);
                doc.setLineWidth(0.2);
                doc.rect(margin, y - 3, pageWidth - (2 * margin), 40, 'S');

                doc.setFontSize(10);

                // Linha 1: Nome e Telefone
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(blackColor[0], blackColor[1], blackColor[2]);
                doc.text('Nome:', margin + 5, y + 5);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(textColor[0], textColor[1], textColor[2]);
                doc.text(cliente.nome || 'Não informado', margin + 30, y + 5);

                doc.setFont('helvetica', 'bold');
                doc.setTextColor(blackColor[0], blackColor[1], blackColor[2]);
                doc.text('Telefone:', margin + 120, y + 5);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(textColor[0], textColor[1], textColor[2]);
                doc.text(cliente.telefone || 'Não informado', margin + 160, y + 5);

                // Linha 2: CPF e E-mail
                y += 10;
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(blackColor[0], blackColor[1], blackColor[2]);
                doc.text('CPF:', margin + 5, y + 5);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(textColor[0], textColor[1], textColor[2]);
                doc.text(cliente.cpf || 'Não informado', margin + 30, y + 5);

                doc.setFont('helvetica', 'bold');
                doc.setTextColor(blackColor[0], blackColor[1], blackColor[2]);
                doc.text('E-mail:', margin + 120, y + 5);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(textColor[0], textColor[1], textColor[2]);
                doc.text(cliente.email || 'Não informado', margin + 150, y + 5);

                // Linha 3: Endereço
                y += 10;
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(blackColor[0], blackColor[1], blackColor[2]);
                doc.text('Endereço:', margin + 5, y + 5);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(textColor[0], textColor[1], textColor[2]);
                const enderecoCompleto = cliente.endereco ?
                    `${cliente.endereco}${cliente.numero ? ', ' + cliente.numero : ''}${cliente.complemento ? ' - ' + cliente.complemento : ''}` :
                    'Não informado';
                doc.text(enderecoCompleto, margin + 45, y + 5);

                y += 20;

                // ===========================================
                // DADOS DO VEÍCULO
                // ===========================================

                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(darkGray[0], darkGray[1], darkGray[2]);
                doc.text('DADOS DO VEÍCULO', margin, y);

                y += 8;

                // Caixa com borda para dados do veículo
                doc.setDrawColor(borderGray[0], borderGray[1], borderGray[2]);
                doc.rect(margin, y - 3, pageWidth - (2 * margin), 30, 'S');

                doc.setFontSize(10);

                // Linha 1: Placa e Marca/Modelo
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(blackColor[0], blackColor[1], blackColor[2]);
                doc.text('Placa:', margin + 5, y + 5);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(textColor[0], textColor[1], textColor[2]);
                doc.text(veiculo.placa || 'Não informado', margin + 30, y + 5);

                doc.setFont('helvetica', 'bold');
                doc.setTextColor(blackColor[0], blackColor[1], blackColor[2]);
                doc.text('Marca/Modelo:', margin + 100, y + 5);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(textColor[0], textColor[1], textColor[2]);
                const modeloCompleto = `${veiculo.marca || ''} ${veiculo.modelo || ''}`.trim() || 'Não informado';
                doc.text(modeloCompleto, margin + 150, y + 5);

                // Linha 2: Ano, Cor e KM
                y += 10;
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(blackColor[0], blackColor[1], blackColor[2]);
                doc.text('Ano:', margin + 5, y + 5);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(textColor[0], textColor[1], textColor[2]);
                doc.text(veiculo.ano || 'Não informado', margin + 25, y + 5);

                doc.setFont('helvetica', 'bold');
                doc.setTextColor(blackColor[0], blackColor[1], blackColor[2]);
                doc.text('Cor:', margin + 80, y + 5);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(textColor[0], textColor[1], textColor[2]);
                doc.text(veiculo.cor || 'Não informado', margin + 100, y + 5);

                doc.setFont('helvetica', 'bold');
                doc.setTextColor(blackColor[0], blackColor[1], blackColor[2]);
                doc.text('KM:', margin + 140, y + 5);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(textColor[0], textColor[1], textColor[2]);
                doc.text(veiculo.km ? `${veiculo.km} km` : 'Não informado', margin + 160, y + 5);

                y += 25;

                // ===========================================
                // TABELA DE ITENS (PROFISSIONAL)
                // ===========================================

                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(darkGray[0], darkGray[1], darkGray[2]);
                doc.text('ITENS DO ORÇAMENTO', margin, y);

                y += 10;

                // Cabeçalho da tabela
                doc.setFillColor(mediumGray[0], mediumGray[1], mediumGray[2]);
                doc.rect(margin, y - 5, pageWidth - (2 * margin), 8, 'F');

                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(255, 255, 255);

                // Posicionamento das colunas
                const colDesc = margin + 5;
                const colQtd = pageWidth - 100;
                const colValor = pageWidth - 70;
                const colTotal = pageWidth - 40;

                doc.text('Descrição do Serviço / Peça', colDesc, y);
                doc.text('Qtd', colQtd, y);
                doc.text('Valor Unit.', colValor, y);
                doc.text('Total', colTotal, y);

                y += 8;

                // Itens da tabela
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(textColor[0], textColor[1], textColor[2]);

                let totalGeral = 0;

                if (orc.itens && Array.isArray(orc.itens) && orc.itens.length > 0) {
                    orc.itens.forEach((item, index) => {
                        if (y > 240) {
                            doc.addPage();
                            y = 20;

                            // Recriar cabeçalho na nova página
                            doc.setFillColor(mediumGray[0], mediumGray[1], mediumGray[2]);
                            doc.rect(margin, y - 5, pageWidth - (2 * margin), 8, 'F');

                            doc.setFontSize(9);
                            doc.setFont('helvetica', 'bold');
                            doc.setTextColor(255, 255, 255);
                            doc.text('Descrição do Serviço / Peça', colDesc, y);
                            doc.text('Qtd', colQtd, y);
                            doc.text('Valor Unit.', colValor, y);
                            doc.text('Total', colTotal, y);

                            y += 8;
                            doc.setFont('helvetica', 'normal');
                            doc.setTextColor(textColor[0], textColor[1], textColor[2]);
                        }

                        // Linhas alternadas (zebrado)
                        if (index % 2 === 0) {
                            doc.setFillColor(lightGray[0], lightGray[1], lightGray[2]);
                            doc.rect(margin, y - 4, pageWidth - (2 * margin), 7, 'F');
                        }

                        const descricao = item.descricao || '-';
                        const qtd = item.quantidade || 0;
                        const valorUnit = item.valorUnitario || 0;
                        const total = item.total || 0;
                        totalGeral += total;

                        // Quebrar descrição longa
                        const descLines = doc.splitTextToSize(descricao, 120);
                        doc.text(descLines, colDesc, y);

                        const descHeight = descLines.length * 4;

                        // Alinhar números à direita
                        doc.text(qtd.toString(), colQtd, y + (descHeight / 2) - 2);
                        doc.text(`R$ ${valorUnit.toFixed(2)}`, colValor, y + (descHeight / 2) - 2);
                        doc.text(`R$ ${total.toFixed(2)}`, colTotal, y + (descHeight / 2) - 2);

                        y += Math.max(descHeight, 6) + 2;
                    });
                } else {
                    doc.text('Nenhum item cadastrado', margin + 5, y);
                    y += 8;
                }

                y += 5;

                // Linha de total
                doc.setDrawColor(mediumGray[0], mediumGray[1], mediumGray[2]);
                doc.setLineWidth(0.3);
                doc.line(pageWidth - 110, y, pageWidth - margin, y);

                y += 7;

                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(blackColor[0], blackColor[1], blackColor[2]);
                doc.text('VALOR TOTAL:', pageWidth - 100, y);
                doc.text(`R$ ${totalGeral.toFixed(2)}`, pageWidth - 40, y, { align: 'right' });

                y += 15;

                // ===========================================
                // OBSERVAÇÕES (se houver)
                // ===========================================

                if (orc.observacoes) {
                    if (y > 230) {
                        doc.addPage();
                        y = 20;
                    }

                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(darkGray[0], darkGray[1], darkGray[2]);
                    doc.text('OBSERVAÇÕES:', margin, y);

                    y += 7;

                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(textColor[0], textColor[1], textColor[2]);

                    const obsLines = doc.splitTextToSize(orc.observacoes, pageWidth - (2 * margin));
                    doc.text(obsLines, margin, y);

                    y += obsLines.length * 5 + 10;
                }

                // ===========================================
                // RODAPÉ PROFISSIONAL
                // ===========================================

                // Posicionar no final da página
                y = pageHeight - 25;

                doc.setDrawColor(borderGray[0], borderGray[1], borderGray[2]);
                doc.setLineWidth(0.2);
                doc.line(margin, y, pageWidth - margin, y);

                y += 5;

                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(mediumGray[0], mediumGray[1], mediumGray[2]);

                const dataEmissao = new Date().toLocaleDateString('pt-BR');
                doc.text(`Documento gerado por AutoFlow em ${dataEmissao}`, pageWidth / 2, y, { align: 'center' });

                y += 4;
                doc.text('Orçamento válido por 7 dias. Este documento é uma simulação, sujeito a alterações.', pageWidth / 2, y, { align: 'center' });

                // Salvar PDF
                doc.save(`orcamento-${orc.numero || 'sem-numero'}.pdf`);
                alert('✅ PDF gerado com sucesso!');

            } catch (error) {
                console.error('Erro detalhado ao gerar PDF:', error);
                alert('❌ Erro ao gerar PDF: ' + error.message);
            }
        };

        // ===========================================
        // ALTERAR STATUS
        // ===========================================
        window.abrirModalStatus = function (id) {
            orcamentoAtualId = id;
            document.getElementById('status-modal').classList.add('active');
        };

        document.getElementById('btn-confirmar-status')?.addEventListener('click', async function () {
            const novoStatus = document.getElementById('novo-status').value;
            const oficinaId = sessionStorage.getItem('oficinaId');

            if (!orcamentoAtualId) return;

            try {
                await db.collection('oficinas').doc(oficinaId).collection('orcamentos').doc(orcamentoAtualId).update({
                    status: novoStatus,
                    updatedAt: new Date().toISOString()
                });

                alert('Status atualizado!');
                document.getElementById('status-modal').classList.remove('active');
                loadOrcamentos();
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao atualizar status');
            }
        });

        // ===========================================
        // EXCLUIR ORÇAMENTO
        // ===========================================
        window.excluirOrcamento = function (id) {
            const oficinaId = sessionStorage.getItem('oficinaId');

            if (!confirm('Excluir este orçamento?')) return;

            db.collection('oficinas').doc(oficinaId).collection('orcamentos').doc(id).delete()
                .then(() => {
                    alert('Orçamento excluído!');
                    loadOrcamentos();
                })
                .catch((error) => {
                    console.error('Erro:', error);
                    alert('Erro ao excluir');
                });
        };

        // ===========================================
        // ESTILOS ADICIONAIS
        // ===========================================
        function adicionarEstilosOrcamento() {
            const style = document.createElement('style');
            style.textContent = `
                .item-orcamento {
                    display: flex;
                    gap: 10px;
                    margin-bottom: 10px;
                    align-items: center;
                }
                .item-orcamento .item-descricao { flex: 1; }
                
                .status-pendente { background: #fff3e0; color: #ef6c00; border: 1px solid #ffb74d; }
                .status-aprovado { background: #e8f5e9; color: #2e7d32; border: 1px solid #a5d6a7; }
                .status-recusado { background: #ffebee; color: #c62828; border: 1px solid #ef9a9a; }
                .status-pago { background: #e8f5e9; color: #2e7d32; border: 1px solid #a5d6a7; }
                .status-concluido { background: #e3f2fd; color: #0d47a1; border: 1px solid #64b5f6; }
                
                .status-badge {
                    padding: 4px 8px;
                    border-radius: 4px;
                    font-size: 12px;
                    font-weight: 500;
                }
            `;
            document.head.appendChild(style);
        }
    </script>
</body>

</html>