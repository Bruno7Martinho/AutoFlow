<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Relat√≥rios - AutoFlow</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/dashboard.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        .admin-container { padding: 20px; }
        
        .relatorios-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .periodo-selector {
            display: flex;
            gap: 10px;
            align-items: center;
            background: white;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .periodo-selector select,
        .periodo-selector input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .relatorios-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .relatorio-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }
        
        .card-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        
        .tabela-resumo {
            width: 100%;
            border-collapse: collapse;
        }
        
        .tabela-resumo td {
            padding: 10px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .tabela-resumo tr:last-child td { border-bottom: none; }
        .tabela-resumo .label { color: #666; }
        .tabela-resumo .value { font-weight: bold; text-align: right; }
        
        .grafico-barras { margin-top: 20px; }
        
        .barra-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .barra-label { width: 100px; font-size: 12px; }
        
        .barra-container {
            flex: 1;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .barra-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #00bcd4);
            border-radius: 10px;
            transition: width 0.3s;
        }
        
        .barra-value {
            width: 80px;
            text-align: right;
            font-size: 12px;
            font-weight: bold;
        }
        
        .tabela-full {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .tabela-full th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            border-bottom: 2px solid #dee2e6;
        }
        
        .tabela-full td {
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
        }
        
        @media (max-width: 768px) {
            .relatorios-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="main-header">
            <div class="logo" style="display: flex; align-items: center; gap: 20px;">
                <img src="../img/logo.png" alt="AutoFlow Logo"
                    style="height: 100px; width: auto; max-width: 400px; object-fit: contain;"
                    onerror="this.style.display='none'">
            </div>
            <nav class="main-nav">
                <ul>
                    <li><a href="admin-dashboard.html">Dashboard</a></li>
                    <li><a href="admin-oficinas.html">Oficinas</a></li>
                    <li><a href="admin-usuarios.html">Usu√°rios</a></li>
                    <li><a href="admin-relatorios.html" class="active">Relat√≥rios</a></li>
                    <li><a href="primeiro-acesso.html">Criar acesso Admin</a></li>
                </ul>
            </nav>
            <div class="user-info" id="user-info"></div>
        </header>

        <main class="main-content">
            <div class="admin-container">
                <div class="relatorios-header">
                    <h2>üìä Relat√≥rios Gerenciais</h2>
                    <div class="periodo-selector">
                        <label>Per√≠odo:</label>
                        <select id="periodo" onchange="mudarPeriodo()">
                            <option value="mes">Este m√™s</option>
                            <option value="trimestre">√öltimo trimestre</option>
                            <option value="ano">Este ano</option>
                            <option value="personalizado">Personalizado</option>
                        </select>
                        <input type="date" id="data-inicio">
                        <input type="date" id="data-fim">
                        <button class="btn btn-primary" onclick="atualizarRelatorios()">Aplicar</button>
                    </div>
                </div>
                
                <!-- Resumo Financeiro -->
                <div class="relatorios-grid">
                    <div class="relatorio-card">
                        <div class="card-header">
                            <span class="card-title">üí∞ Resumo Financeiro</span>
                        </div>
                        <table class="tabela-resumo">
                            <tr>
                                <td class="label">Faturamento Total:</td>
                                <td class="value" id="faturamento-total">R$ 0,00</td>
                            </tr>
                            <tr>
                                <td class="label">Receita Planos:</td>
                                <td class="value" id="receita-planos">R$ 0,00</td>
                            </tr>
                            <tr>
                                <td class="label">Ticket M√©dio:</td>
                                <td class="value" id="ticket-medio">R$ 0,00</td>
                            </tr>
                            <tr>
                                <td class="label">Proje√ß√£o Anual:</td>
                                <td class="value" id="projecao-anual">R$ 0,00</td>
                            </tr>
                        </table>
                    </div>
                    
                    <div class="relatorio-card">
                        <div class="card-header">
                            <span class="card-title">üìà Crescimento</span>
                        </div>
                        <table class="tabela-resumo">
                            <tr>
                                <td class="label">Novas Oficinas:</td>
                                <td class="value" id="novas-oficinas">0</td>
                            </tr>
                            <tr>
                                <td class="label">Oficinas Ativas:</td>
                                <td class="value" id="oficinas-ativas-periodo">0</td>
                            </tr>
                            <tr>
                                <td class="label">Cancelamentos:</td>
                                <td class="value" id="cancelamentos">0</td>
                            </tr>
                            <tr>
                                <td class="label">Upgrades:</td>
                                <td class="value" id="upgrades">0</td>
                            </tr>
                        </table>
                    </div>
                </div>
                
                <!-- Distribui√ß√£o por Plano -->
                <div class="relatorio-card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <span class="card-title">üìä Distribui√ß√£o por Plano</span>
                    </div>
                    
                    <div class="grafico-barras">
                        <div class="barra-item">
                            <span class="barra-label">B√°sico (R$30)</span>
                            <div class="barra-container">
                                <div class="barra-fill" id="barra-basico" style="width: 0%"></div>
                            </div>
                            <span class="barra-value" id="valor-basico">0</span>
                        </div>
                        <div class="barra-item">
                            <span class="barra-label">Intermedi√°rio (R$50)</span>
                            <div class="barra-container">
                                <div class="barra-fill" id="barra-intermediario" style="width: 0%"></div>
                            </div>
                            <span class="barra-value" id="valor-intermediario">0</span>
                        </div>
                        <div class="barra-item">
                            <span class="barra-label">Completo (R$70)</span>
                            <div class="barra-container">
                                <div class="barra-fill" id="barra-completo" style="width: 0%"></div>
                            </div>
                            <span class="barra-value" id="valor-completo">0</span>
                        </div>
                    </div>
                </div>
                
                <!-- Top Oficinas -->
                <div class="relatorio-card">
                    <div class="card-header">
                        <span class="card-title">üèÜ Top 10 Oficinas</span>
                    </div>
                    
                    <table class="tabela-full">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Oficina</th>
                                <th>Plano</th>
                                <th>Clientes</th>
                                <th>Or√ßamentos</th>
                                <th>Faturamento</th>
                            </tr>
                        </thead>
                        <tbody id="top-oficinas">
                            <tr><td colspan="6" class="text-center">Carregando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script src="../js/firebase-config.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            auth.onAuthStateChanged(function(user) {
                if (user) {
                    const ADMIN_EMAILS = ['admin@autoflow.com', 'rafael@gmail.com', 'admin@gmail.com'];
                    
                    if (!ADMIN_EMAILS.includes(user.email)) {
                        window.location.href = 'dashboard.html';
                        return;
                    }
                    
                    loadUserInfo(user);
                    configurarDatas();
                    atualizarRelatorios();
                } else {
                    window.location.href = 'login.html';
                }
            });
        });
        
        function loadUserInfo(user) {
            document.getElementById('user-info').innerHTML = `
                <span class="user-email">üëë ${user.email}</span>
                <button id="logout-btn" class="btn btn-sm btn-danger">Sair</button>
            `;
            document.getElementById('logout-btn').addEventListener('click', () => {
                sessionStorage.clear();
                auth.signOut();
                window.location.href = 'login.html';
            });
        }
        
        function configurarDatas() {
            const hoje = new Date();
            const primeiroDia = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
            
            document.getElementById('data-inicio').value = primeiroDia.toISOString().split('T')[0];
            document.getElementById('data-fim').value = hoje.toISOString().split('T')[0];
        }
        
        function mudarPeriodo() {
            const periodo = document.getElementById('periodo').value;
            const hoje = new Date();
            let inicio;
            
            switch(periodo) {
                case 'mes':
                    inicio = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
                    break;
                case 'trimestre':
                    inicio = new Date(hoje.getFullYear(), hoje.getMonth() - 3, 1);
                    break;
                case 'ano':
                    inicio = new Date(hoje.getFullYear(), 0, 1);
                    break;
                default:
                    return;
            }
            
            document.getElementById('data-inicio').value = inicio.toISOString().split('T')[0];
            document.getElementById('data-fim').value = hoje.toISOString().split('T')[0];
        }
        
        window.atualizarRelatorios = async function() {
            try {
                const inicio = new Date(document.getElementById('data-inicio').value);
                const fim = new Date(document.getElementById('data-fim').value);
                fim.setHours(23, 59, 59);
                
                const oficinasSnap = await db.collection('oficinas').get();
                
                let totalOficinasPeriodo = 0;
                let qtdBasico = 0;
                let qtdIntermediario = 0;
                let qtdCompleto = 0;
                let novasOficinas = 0;
                let cancelamentos = 0;
                let upgrades = 0;
                
                const topOficinas = [];
                
                for (const doc of oficinasSnap.docs) {
                    const of = doc.data();
                    
                    // Verificar se a oficina estava ativa no per√≠odo
                    const dataCriacao = of.createdAt ? (of.createdAt.toDate ? of.createdAt.toDate() : new Date(of.createdAt)) : null;
                    
                    if (dataCriacao && dataCriacao <= fim) {
                        totalOficinasPeriodo++;
                        
                        // Contagem por plano
                        if (of.plano === 'basico') qtdBasico++;
                        else if (of.plano === 'intermediario') qtdIntermediario++;
                        else if (of.plano === 'completo') qtdCompleto++;
                        
                        // Novas oficinas no per√≠odo
                        if (dataCriacao >= inicio && dataCriacao <= fim) {
                            novasOficinas++;
                        }
                        
                        // Cancelamentos (oficinas inativas no per√≠odo)
                        if (of.status === 'inativa' && of.updatedAt) {
                            const dataAtualizacao = of.updatedAt.toDate ? of.updatedAt.toDate() : new Date(of.updatedAt);
                            if (dataAtualizacao >= inicio && dataAtualizacao <= fim) {
                                cancelamentos++;
                            }
                        }
                        
                        // Coletar dados para top oficinas
                        try {
                            const clientesSnap = await db.collection('oficinas').doc(doc.id).collection('clientes').get();
                            const orcamentosSnap = await db.collection('oficinas').doc(doc.id).collection('orcamentos').get();
                            
                            const precos = { basico: 30, intermediario: 50, completo: 70 };
                            
                            topOficinas.push({
                                nome: of.nome || 'Sem nome',
                                plano: of.plano || 'basico',
                                clientes: clientesSnap.size,
                                orcamentos: orcamentosSnap.size,
                                faturamento: precos[of.plano] || 30
                            });
                        } catch (e) {}
                    }
                }
                
                // Calcular totais
                const faturamentoTotal = (qtdBasico * 30) + (qtdIntermediario * 50) + (qtdCompleto * 70);
                const ticketMedio = totalOficinasPeriodo ? faturamentoTotal / totalOficinasPeriodo : 0;
                
                // Atualizar UI
                document.getElementById('faturamento-total').textContent = `R$ ${faturamentoTotal.toFixed(2)}`;
                document.getElementById('receita-planos').textContent = `R$ ${faturamentoTotal.toFixed(2)}`;
                document.getElementById('ticket-medio').textContent = `R$ ${ticketMedio.toFixed(2)}`;
                document.getElementById('projecao-anual').textContent = `R$ ${(faturamentoTotal * 12).toFixed(2)}`;
                
                document.getElementById('novas-oficinas').textContent = novasOficinas;
                document.getElementById('oficinas-ativas-periodo').textContent = totalOficinasPeriodo;
                document.getElementById('cancelamentos').textContent = cancelamentos;
                document.getElementById('upgrades').textContent = upgrades;
                
                // Atualizar barras
                const total = qtdBasico + qtdIntermediario + qtdCompleto;
                if (total > 0) {
                    document.getElementById('barra-basico').style.width = `${(qtdBasico / total) * 100}%`;
                    document.getElementById('barra-intermediario').style.width = `${(qtdIntermediario / total) * 100}%`;
                    document.getElementById('barra-completo').style.width = `${(qtdCompleto / total) * 100}%`;
                }
                
                document.getElementById('valor-basico').textContent = qtdBasico;
                document.getElementById('valor-intermediario').textContent = qtdIntermediario;
                document.getElementById('valor-completo').textContent = qtdCompleto;
                
                // Top oficinas (ordenar por n√∫mero de or√ßamentos)
                const top10 = topOficinas.sort((a, b) => b.orcamentos - a.orcamentos).slice(0, 10);
                
                if (top10.length === 0) {
                    document.getElementById('top-oficinas').innerHTML = '<tr><td colspan="6" class="text-center">Nenhuma oficina encontrada no per√≠odo</td></tr>';
                } else {
                    let html = '';
                    top10.forEach((of, index) => {
                        html += `
                            <tr>
                                <td>${index + 1}</td>
                                <td><strong>${of.nome}</strong></td>
                                <td>${of.plano}</td>
                                <td>${of.clientes}</td>
                                <td>${of.orcamentos}</td>
                                <td>R$ ${of.faturamento.toFixed(2)}</td>
                            </tr>
                        `;
                    });
                    document.getElementById('top-oficinas').innerHTML = html;
                }
                
            } catch (error) {
                console.error('Erro ao atualizar relat√≥rios:', error);
            }
        };
    </script>
</body>
</html>