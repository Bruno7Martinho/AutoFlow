<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orçamento Rápido - AutoFlow</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/dashboard.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <!-- Bibliotecas para PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* ===========================================
           ESTILOS PARA FILTROS E BARRA DE BUSCA
        =========================================== */
        .filters-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            background-color: #f8f9fa;
            padding: 15px;
            border: 1px solid #e0e0e0;
            align-items: center;
        }

        .filters-bar input[type="text"] {
            flex: 2;
            min-width: 250px;
            padding: 10px 12px;
            border: 1px solid #ddd;
            font-size: 14px;
            background-color: white;
        }

        .filters-bar input[type="text"]:focus {
            border-color: #c62828;
            outline: none;
            box-shadow: 0 0 0 3px rgba(198, 40, 40, 0.1);
        }

        .filters-bar select {
            flex: 1;
            min-width: 180px;
            padding: 10px 12px;
            border: 1px solid #ddd;
            font-size: 14px;
            background-color: white;
            cursor: pointer;
        }

        .filters-bar select:focus {
            border-color: #c62828;
            outline: none;
        }

        /* ===========================================
           ESTILOS PARA ITENS DO ORÇAMENTO
        =========================================== */
        .item-orcamento {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
            background-color: #f9f9f9;
            padding: 10px;
            border: 1px solid #e0e0e0;
        }

        .item-orcamento .item-descricao {
            flex: 1;
        }

        .item-orcamento input[type="number"] {
            width: 100px;
        }

        .item-orcamento .btn-danger {
            width: 40px;
        }

        /* ===========================================
           ESTILOS PARA BADGES DE STATUS
        =========================================== */
        .status-pendente {
            background: #fff3e0;
            color: #ef6c00;
            border: 1px solid #ffb74d;
        }

        .status-aprovado {
            background: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #a5d6a7;
        }

        .status-recusado {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ef9a9a;
        }

        .status-concluido {
            background: #e3f2fd;
            color: #0d47a1;
            border: 1px solid #64b5f6;
        }

        .status-pago {
            background: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #a5d6a7;
        }

        .status-badge {
            padding: 4px 8px;
            font-size: 12px;
            font-weight: 500;
            display: inline-block;
        }

        /* ===========================================
           ESTILOS PARA TABELA
        =========================================== */
        .table-container {
            overflow-x: auto;
            border: 1px solid #e0e0e0;
            background: white;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background-color: #f5f5f5;
            color: #333;
            font-weight: 600;
            text-align: left;
            padding: 12px 15px;
            border-bottom: 2px solid #ddd;
        }

        .data-table td {
            padding: 10px 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .data-table tbody tr:hover {
            background-color: #f9f9f9;
        }

        .actions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        /* ===========================================
           ESTILOS PARA RESPONSIVIDADE
        =========================================== */
        @media (max-width: 768px) {
            .filters-bar {
                flex-direction: column;
            }

            .filters-bar input[type="text"],
            .filters-bar select {
                width: 100%;
            }

            .item-orcamento {
                flex-wrap: wrap;
            }

            .item-orcamento input[type="text"],
            .item-orcamento input[type="number"] {
                width: 100% !important;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header class="main-header">
            <div class="logo" style="display: flex; align-items: center; gap: 20px;">
                <img src="../img/logo.png" alt="AutoFlow Logo"
                    style="height: 100px; width: auto; max-width: 400px; object-fit: contain;"
                    onerror="this.style.display='none'">
            </div>
            <nav class="main-nav" id="main-nav">
                <!-- Plano básico não tem navegação -->
            </nav>
            <div class="user-info" id="user-info"></div>
        </header>

        <main class="main-content">
            <div class="dashboard-section">
                <div class="section-header">
                    <h2>Orçamentos</h2>
                    <button id="btn-novo-orcamento" class="btn btn-success">+ Novo Orçamento Rápido</button>
                </div>

                <div class="filters-bar">
                    <input type="text" id="search" placeholder="Buscar por cliente...">
                    <select id="filter-status">
                        <option value="">Todos status</option>
                        <option value="pendente">Pendente</option>
                        <option value="aprovado">Aprovado</option>
                        <option value="recusado">Recusado</option>
                        <option value="concluido">Concluído</option>
                        <option value="pago">Pago</option>
                    </select>
                </div>

                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Número</th>
                                <th>Cliente</th>
                                <th>Veículo</th>
                                <th>Data</th>
                                <th>Valor</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="orcamentos-body"></tbody>
                    </table>
                </div>

                <div class="loader" id="loader"></div>
            </div>
        </main>

        <footer class="main-footer">
            <p>&copy; 2026 AutoFlow. Todos os direitos reservados.</p>
        </footer>
    </div>

    <!-- MODAL: Novo Orçamento Rápido -->
    <div id="orcamento-modal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>Novo Orçamento Rápido</h2>
                <button class="modal-close">&times;</button>
            </div>

            <form id="form-orcamento">
                <!-- Dados do Cliente -->
                <div style="background: #f8f9fa; padding: 15px; margin-bottom: 20px; border: 1px solid #e0e0e0;">
                    <h3 style="margin: 0 0 15px 0; font-size: 1rem;">Dados do Cliente</h3>

                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label>Nome *</label>
                            <input type="text" id="cliente-nome" class="form-control" required>
                        </div>
                        <div class="form-group col-md-6">
                            <label>Telefone *</label>
                            <input type="tel" id="cliente-telefone" class="form-control" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group col-md-4">
                            <label>CPF</label>
                            <input type="text" id="cliente-cpf" class="form-control">
                        </div>
                        <div class="form-group col-md-4">
                            <label>E-mail</label>
                            <input type="email" id="cliente-email" class="form-control">
                        </div>
                    </div>
                </div>

                <!-- Dados do Veículo -->
                <div style="background: #f8f9fa; padding: 15px; margin-bottom: 20px; border: 1px solid #e0e0e0;">
                    <h3 style="margin: 0 0 15px 0; font-size: 1rem;">Dados do Veículo</h3>

                    <div class="form-row">
                        <div class="form-group col-md-3">
                            <label>Marca *</label>
                            <input type="text" id="veiculo-marca" class="form-control" required>
                        </div>
                        <div class="form-group col-md-3">
                            <label>Modelo *</label>
                            <input type="text" id="veiculo-modelo" class="form-control" required>
                        </div>
                        <div class="form-group col-md-2">
                            <label>Ano</label>
                            <input type="number" id="veiculo-ano" class="form-control">
                        </div>
                        <div class="form-group col-md-2">
                            <label>Placa</label>
                            <input type="text" id="veiculo-placa" class="form-control"
                                style="text-transform: uppercase;">
                        </div>
                        <div class="form-group col-md-2">
                            <label>KM</label>
                            <input type="number" id="veiculo-km" class="form-control">
                        </div>
                    </div>
                </div>

                <!-- Informações do Orçamento -->
                <div class="form-row">
                    <div class="form-group col-md-4">
                        <label>Número</label>
                        <input type="text" id="orcamento-numero" class="form-control" readonly>
                    </div>

                    <div class="form-group col-md-4">
                        <label>Status</label>
                        <select id="orcamento-status" class="form-control">
                            <option value="pendente">Pendente</option>
                            <option value="aprovado">Aprovado</option>
                            <option value="recusado">Recusado</option>
                        </select>
                    </div>

                    <div class="form-group col-md-4">
                        <label>Data</label>
                        <input type="date" id="orcamento-data" class="form-control">
                    </div>
                </div>

                <!-- Itens do Orçamento -->
                <div class="form-group">
                    <label>Itens do Orçamento</label>
                    <div id="itens-container">
                        <div class="item-orcamento">
                            <input type="text" class="item-descricao form-control"
                                placeholder="Descrição do serviço/peça">
                            <input type="number" class="item-quantidade form-control" value="1" min="1"
                                style="width: 80px;">
                            <input type="number" class="item-valor form-control" placeholder="Valor unitário"
                                step="0.01" style="width: 120px;">
                            <button type="button" class="btn btn-sm btn-danger remover-item">×</button>
                        </div>
                    </div>
                    <button type="button" id="btn-add-item" class="btn btn-sm btn-secondary" style="margin-top: 10px;">+
                        Adicionar Item</button>
                </div>

                <!-- Total e Observações -->
                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label>Observações</label>
                        <textarea id="observacoes" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="form-group col-md-6" style="text-align: right;">
                        <label>Total</label>
                        <div style="font-size: 24px; font-weight: bold; color: #c62828;" id="total-orcamento">R$ 0,00
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Salvar Orçamento</button>
                    <button type="button" class="btn btn-secondary modal-close">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL: Visualizar Orçamento -->
    <div id="view-orcamento-modal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>Detalhes do Orçamento</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div id="orcamento-detalhes" style="padding: 20px;"></div>
            <div class="form-actions">
                <button type="button" class="btn btn-success" id="btn-pdf-detalhe">Gerar PDF</button>
                <button type="button" class="btn btn-secondary modal-close">Fechar</button>
            </div>
        </div>
    </div>

    <script src="../js/firebase-config.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function () {
            const oficinaId = sessionStorage.getItem('oficinaId');
            const oficinaNome = sessionStorage.getItem('oficinaNome') || 'Oficina';

            auth.onAuthStateChanged(async function (user) {
                if (!user || !oficinaId) {
                    window.location.href = 'login.html';
                    return;
                }

                loadUserInfo(user);
                carregarOrcamentos();
            });

            // ===========================================
            // ELEMENTOS
            // ===========================================
            const modal = document.getElementById('orcamento-modal');
            const viewModal = document.getElementById('view-orcamento-modal');
            const form = document.getElementById('form-orcamento');

            // ===========================================
            // FUNÇÃO PARA DEFINIR DATA ATUAL
            // ===========================================
            function setDefaultDate() {
                const hoje = new Date();
                const ano = hoje.getFullYear();
                const mes = String(hoje.getMonth() + 1).padStart(2, '0');
                const dia = String(hoje.getDate()).padStart(2, '0');
                document.getElementById('orcamento-data').value = `${ano}-${mes}-${dia}`;
            }

            // ===========================================
            // CARREGAR ORÇAMENTOS
            // ===========================================
            async function carregarOrcamentos() {
                const loader = document.getElementById('loader');
                const tbody = document.getElementById('orcamentos-body');
                const oficinaId = sessionStorage.getItem('oficinaId');

                loader.style.display = 'block';
                tbody.innerHTML = '';

                try {
                    const snapshot = await db.collection('oficinas')
                        .doc(oficinaId)
                        .collection('orcamentos')
                        .orderBy('data', 'desc')
                        .get();

                    loader.style.display = 'none';

                    if (snapshot.empty) {
                        tbody.innerHTML = '<tr><td colspan="7" class="text-center">Nenhum orçamento encontrado</td></tr>';
                        return;
                    }

                    snapshot.forEach(doc => {
                        const orc = doc.data();
                        const data = orc.data ? new Date(orc.data).toLocaleDateString('pt-BR') : '-';

                        // Nome do cliente (vem do objeto cliente)
                        const nomeCliente = orc.cliente?.nome || '-';

                        // Veículo
                        let veiculoStr = '-';
                        if (orc.veiculo?.marca && orc.veiculo?.modelo) {
                            veiculoStr = `${orc.veiculo.marca} ${orc.veiculo.modelo}`;
                        }

                        const statusClass = {
                            'pendente': 'status-pendente',
                            'aprovado': 'status-aprovado',
                            'recusado': 'status-recusado',
                            'concluido': 'status-concluido',
                            'pago': 'status-pago'
                        }[orc.status] || '';

                        const statusText = {
                            'pendente': 'Pendente',
                            'aprovado': 'Aprovado',
                            'recusado': 'Recusado',
                            'concluido': 'Concluído',
                            'pago': 'Pago'
                        }[orc.status] || orc.status;

                        tbody.innerHTML += `
                            <tr>
                                <td><strong>${orc.numero || 'N/A'}</strong></td>
                                <td>${nomeCliente}</td>
                                <td>${veiculoStr}</td>
                                <td>${data}</td>
                                <td>R$ ${(orc.valorTotal || 0).toFixed(2)}</td>
                                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                                <td class="actions">
                                    <button class="btn btn-sm btn-info" onclick="verOrcamento('${doc.id}')">Ver</button>
                                    <button class="btn btn-sm btn-warning" onclick="gerarPDF('${doc.id}')">PDF</button>
                                    <button class="btn btn-sm btn-danger" onclick="excluirOrcamento('${doc.id}')">Excluir</button>
                                </td>
                            </tr>
                        `;
                    });

                } catch (error) {
                    console.error('Erro:', error);
                    loader.style.display = 'none';
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center">Erro ao carregar</td></tr>';
                }
            }

            // ===========================================
            // FUNÇÕES AUXILIARES
            // ===========================================
            function loadUserInfo(user) {
                document.getElementById('user-info').innerHTML = `
                    <span class="user-email">${user.email}</span>
                    <button id="logout-btn" class="btn btn-sm btn-danger">Sair</button>
                `;
                document.getElementById('logout-btn').addEventListener('click', logout);
            }

            window.logout = () => {
                sessionStorage.clear();
                auth.signOut();
                window.location.href = 'login.html';
            };

            // ===========================================
            // NOVO ORÇAMENTO
            // ===========================================
            document.getElementById('btn-novo-orcamento').addEventListener('click', function () {
                gerarNumeroOrcamento();
                setDefaultDate();
                modal.classList.add('active');
            });

            document.querySelectorAll('.modal-close').forEach(btn => {
                btn.addEventListener('click', () => {
                    modal.classList.remove('active');
                    viewModal.classList.remove('active');
                });
            });

            // Gerar número automático
            async function gerarNumeroOrcamento() {
                const oficinaId = sessionStorage.getItem('oficinaId');
                const ano = new Date().getFullYear();

                try {
                    const snapshot = await db.collection('oficinas')
                        .doc(oficinaId)
                        .collection('orcamentos')
                        .orderBy('numero', 'desc')
                        .limit(1)
                        .get();

                    let proximoNumero = 1;

                    if (!snapshot.empty) {
                        const ultimo = snapshot.docs[0].data();
                        const partes = ultimo.numero?.split('-') || [];
                        if (partes.length === 3 && partes[2]) {
                            const num = parseInt(partes[2]);
                            if (!isNaN(num)) proximoNumero = num + 1;
                        }
                    }

                    document.getElementById('orcamento-numero').value = `ORC-${ano}-${proximoNumero.toString().padStart(4, '0')}`;
                } catch {
                    document.getElementById('orcamento-numero').value = `ORC-${ano}-0001`;
                }
            }

            // ===========================================
            // ITENS DO ORÇAMENTO
            // ===========================================
            document.getElementById('btn-add-item').addEventListener('click', function () {
                const container = document.getElementById('itens-container');
                const item = document.createElement('div');
                item.className = 'item-orcamento';
                item.innerHTML = `
                    <input type="text" class="item-descricao form-control" placeholder="Descrição">
                    <input type="number" class="item-quantidade form-control" value="1" min="1" style="width: 80px;">
                    <input type="number" class="item-valor form-control" placeholder="Valor" step="0.01" style="width: 120px;">
                    <button type="button" class="btn btn-sm btn-danger remover-item">×</button>
                `;
                container.appendChild(item);
            });

            document.getElementById('itens-container').addEventListener('click', function (e) {
                if (e.target.classList.contains('remover-item')) {
                    if (document.querySelectorAll('.item-orcamento').length > 1) {
                        e.target.closest('.item-orcamento').remove();
                        calcularTotal();
                    }
                }
            });

            document.getElementById('itens-container').addEventListener('input', calcularTotal);

            function calcularTotal() {
                let total = 0;
                document.querySelectorAll('.item-orcamento').forEach(item => {
                    const qtd = parseFloat(item.querySelector('.item-quantidade').value) || 0;
                    const valor = parseFloat(item.querySelector('.item-valor').value) || 0;
                    total += qtd * valor;
                });
                document.getElementById('total-orcamento').textContent = `R$ ${total.toFixed(2)}`;
            }

            // ===========================================
            // SALVAR ORÇAMENTO
            // ===========================================
            form.addEventListener('submit', async function (e) {
                e.preventDefault();

                const oficinaId = sessionStorage.getItem('oficinaId');

                // Validar cliente
                if (!document.getElementById('cliente-nome').value || !document.getElementById('cliente-telefone').value) {
                    alert('Nome e telefone do cliente são obrigatórios');
                    return;
                }

                // Validar veículo
                if (!document.getElementById('veiculo-marca').value || !document.getElementById('veiculo-modelo').value) {
                    alert('Marca e modelo do veículo são obrigatórios');
                    return;
                }

                // Coletar itens
                const itens = [];
                document.querySelectorAll('.item-orcamento').forEach(item => {
                    const descricao = item.querySelector('.item-descricao').value;
                    const qtd = parseFloat(item.querySelector('.item-quantidade').value) || 0;
                    const valor = parseFloat(item.querySelector('.item-valor').value) || 0;

                    if (descricao && qtd > 0 && valor > 0) {
                        itens.push({
                            descricao: descricao,
                            quantidade: qtd,
                            valorUnitario: valor,
                            total: qtd * valor
                        });
                    }
                });

                if (itens.length === 0) {
                    alert('Adicione pelo menos um item válido');
                    return;
                }

                const orcamentoData = {
                    numero: document.getElementById('orcamento-numero').value,
                    cliente: {
                        nome: document.getElementById('cliente-nome').value,
                        telefone: document.getElementById('cliente-telefone').value,
                        cpf: document.getElementById('cliente-cpf').value,
                        email: document.getElementById('cliente-email').value
                    },
                    veiculo: {
                        marca: document.getElementById('veiculo-marca').value,
                        modelo: document.getElementById('veiculo-modelo').value,
                        ano: document.getElementById('veiculo-ano').value,
                        placa: document.getElementById('veiculo-placa').value.toUpperCase(),
                        km: document.getElementById('veiculo-km').value
                    },
                    status: document.getElementById('orcamento-status').value,
                    data: document.getElementById('orcamento-data').value,
                    itens: itens,
                    valorTotal: itens.reduce((acc, item) => acc + item.total, 0),
                    observacoes: document.getElementById('observacoes').value,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };

                try {
                    await db.collection('oficinas').doc(oficinaId).collection('orcamentos').add(orcamentoData);
                    alert('Orçamento salvo com sucesso!');
                    modal.classList.remove('active');
                    form.reset();
                    carregarOrcamentos();
                } catch (error) {
                    console.error('Erro:', error);
                    alert('Erro ao salvar orçamento');
                }
            });

            // ===========================================
            // VISUALIZAR ORÇAMENTO
            // ===========================================
            window.verOrcamento = async function (id) {
                const oficinaId = sessionStorage.getItem('oficinaId');

                try {
                    const doc = await db.collection('oficinas').doc(oficinaId).collection('orcamentos').doc(id).get();

                    if (!doc.exists) {
                        alert('Orçamento não encontrado');
                        return;
                    }

                    const orc = doc.data();

                    let html = `
                        <div style="margin-bottom: 20px;">
                            <h3>Orçamento ${orc.numero}</h3>
                            <p><strong>Data:</strong> ${new Date(orc.data).toLocaleDateString('pt-BR')}</p>
                            <p><strong>Status:</strong> <span class="status-badge status-${orc.status}">${orc.status}</span></p>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div>
                                <h4>Cliente</h4>
                                <p><strong>Nome:</strong> ${orc.cliente?.nome || '-'}</p>
                                <p><strong>Telefone:</strong> ${orc.cliente?.telefone || '-'}</p>
                                <p><strong>CPF:</strong> ${orc.cliente?.cpf || '-'}</p>
                                <p><strong>Email:</strong> ${orc.cliente?.email || '-'}</p>
                            </div>
                            <div>
                                <h4>Veículo</h4>
                                <p><strong>Marca:</strong> ${orc.veiculo?.marca || '-'}</p>
                                <p><strong>Modelo:</strong> ${orc.veiculo?.modelo || '-'}</p>
                                <p><strong>Ano:</strong> ${orc.veiculo?.ano || '-'}</p>
                                <p><strong>Placa:</strong> ${orc.veiculo?.placa || '-'}</p>
                                <p><strong>KM:</strong> ${orc.veiculo?.km || '-'}</p>
                            </div>
                        </div>
                        
                        <h4>Itens</h4>
                        <table class="data-table" style="margin-bottom: 20px;">
                            <thead>
                                <tr>
                                    <th>Descrição</th>
                                    <th>Qtd</th>
                                    <th>Valor Unit.</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    if (orc.itens && Array.isArray(orc.itens) && orc.itens.length > 0) {
                        orc.itens.forEach(item => {
                            html += `
                                <tr>
                                    <td>${item.descricao}</td>
                                    <td>${item.quantidade}</td>
                                    <td>R$ ${item.valorUnitario.toFixed(2)}</td>
                                    <td>R$ ${item.total.toFixed(2)}</td>
                                </tr>
                            `;
                        });
                    } else {
                        html += `<tr><td colspan="4" class="text-center">Nenhum item cadastrado</td></tr>`;
                    }

                    html += `
                            <tr style="font-weight: bold;">
                                <td colspan="3" style="text-align: right;">Total:</td>
                                <td>R$ ${orc.valorTotal ? orc.valorTotal.toFixed(2) : '0,00'}</td>
                            </tr>
                        </tbody>
                    </table>
                    `;

                    if (orc.observacoes) {
                        html += `<p><strong>Observações:</strong> ${orc.observacoes}</p>`;
                    }

                    document.getElementById('orcamento-detalhes').innerHTML = html;

                    document.getElementById('btn-pdf-detalhe').onclick = () => gerarPDF(id);

                    viewModal.classList.add('active');

                } catch (error) {
                    console.error('Erro:', error);
                    alert('Erro ao carregar orçamento');
                }
            };

            // ===========================================
            // GERAR PDF
            // ===========================================
            // ===========================================
            // GERAR PDF - VERSÃO NEUTRA E PROFISSIONAL
            // ===========================================
            window.gerarPDF = async function (id) {
                const oficinaId = sessionStorage.getItem('oficinaId');
                const oficinaNome = sessionStorage.getItem('oficinaNome') || 'AutoFlow';

                try {
                    const docSnap = await db.collection('oficinas').doc(oficinaId).collection('orcamentos').doc(id).get();

                    if (!docSnap.exists) {
                        alert('Orçamento não encontrado');
                        return;
                    }

                    const orc = docSnap.data();

                    // Buscar dados completos do cliente e veículo
                    let cliente = { nome: 'Não informado', telefone: '', email: '', cpf: '', endereco: '' };
                    let veiculo = { placa: '', marca: '', modelo: '', ano: '', cor: '', km: '' };

                    if (orc.clienteId) {
                        const clienteDoc = await db.collection('oficinas').doc(oficinaId).collection('clientes').doc(orc.clienteId).get();
                        if (clienteDoc.exists) {
                            cliente = clienteDoc.data();
                        }
                    } else if (orc.cliente) {
                        cliente = orc.cliente;
                    }

                    if (orc.veiculoId) {
                        const veiculoDoc = await db.collection('oficinas').doc(oficinaId).collection('veiculos').doc(orc.veiculoId).get();
                        if (veiculoDoc.exists) {
                            veiculo = veiculoDoc.data();
                        }
                    } else if (orc.veiculo) {
                        veiculo = orc.veiculo;
                    }

                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();

                    // Configurações de estilo - Paleta NEUTRA
                    const pageWidth = doc.internal.pageSize.width;
                    const pageHeight = doc.internal.pageSize.height;
                    const margin = 20;
                    let y = margin;

                    // Cores neutras e profissionais
                    const darkGray = [60, 60, 60];      // Cinza escuro para títulos
                    const mediumGray = [100, 100, 100];  // Cinza médio para subtítulos
                    const lightGray = [245, 245, 245];   // Cinza claríssimo para fundos
                    const borderGray = [220, 220, 220];  // Cinza para bordas
                    const textColor = [80, 80, 80];       // Cinza para texto
                    const blackColor = [0, 0, 0];          // Preto para textos importantes

                    // ===========================================
                    // CABEÇALHO PROFISSIONAL
                    // ===========================================

                    // Linha superior elegante
                    doc.setFillColor(mediumGray[0], mediumGray[1], mediumGray[2]);
                    doc.rect(0, 0, pageWidth, 2, 'F');

                    y += 15;

                    // Nome da oficina/empresa
                    doc.setFontSize(22);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(darkGray[0], darkGray[1], darkGray[2]);
                    doc.text(oficinaNome.toUpperCase(), pageWidth / 2, y, { align: 'center' });

                    y += 10;

                    // Título do documento
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(mediumGray[0], mediumGray[1], mediumGray[2]);
                    doc.text('ORÇAMENTO DE SERVIÇOS', pageWidth / 2, y, { align: 'center' });

                    y += 15;

                    // Linha divisória dupla (mais elegante)
                    doc.setDrawColor(borderGray[0], borderGray[1], borderGray[2]);
                    doc.setLineWidth(0.3);
                    doc.line(margin, y, pageWidth - margin, y);

                    y += 10;

                    // ===========================================
                    // NÚMERO E DATA (em caixa)
                    // ===========================================

                    // Fundo cinza claro para destacar informações principais
                    doc.setFillColor(lightGray[0], lightGray[1], lightGray[2]);
                    doc.rect(margin, y - 5, pageWidth - (2 * margin), 18, 'F');

                    // Número do orçamento
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(blackColor[0], blackColor[1], blackColor[2]);
                    doc.text('ORÇAMENTO Nº:', margin + 5, y);

                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(textColor[0], textColor[1], textColor[2]);
                    doc.text(orc.numero || 'N/A', margin + 45, y);

                    // Data
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(blackColor[0], blackColor[1], blackColor[2]);
                    doc.text('DATA:', pageWidth - 100, y);

                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(textColor[0], textColor[1], textColor[2]);
                    const dataFormatada = orc.data ? new Date(orc.data).toLocaleDateString('pt-BR') : '-';
                    doc.text(dataFormatada, pageWidth - 75, y);

                    y += 20;

                    // ===========================================
                    // DADOS DO CLIENTE (com bordas elegantes)
                    // ===========================================

                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(darkGray[0], darkGray[1], darkGray[2]);
                    doc.text('DADOS DO CLIENTE', margin, y);

                    y += 8;

                    // Caixa com borda para dados do cliente
                    doc.setDrawColor(borderGray[0], borderGray[1], borderGray[2]);
                    doc.setLineWidth(0.2);
                    doc.rect(margin, y - 3, pageWidth - (2 * margin), 40, 'S');

                    doc.setFontSize(10);

                    // Linha 1: Nome e Telefone
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(blackColor[0], blackColor[1], blackColor[2]);
                    doc.text('Nome:', margin + 5, y + 5);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(textColor[0], textColor[1], textColor[2]);
                    doc.text(cliente.nome || 'Não informado', margin + 30, y + 5);

                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(blackColor[0], blackColor[1], blackColor[2]);
                    doc.text('Telefone:', margin + 120, y + 5);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(textColor[0], textColor[1], textColor[2]);
                    doc.text(cliente.telefone || 'Não informado', margin + 160, y + 5);

                    // Linha 2: CPF e E-mail
                    y += 10;
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(blackColor[0], blackColor[1], blackColor[2]);
                    doc.text('CPF:', margin + 5, y + 5);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(textColor[0], textColor[1], textColor[2]);
                    doc.text(cliente.cpf || 'Não informado', margin + 30, y + 5);

                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(blackColor[0], blackColor[1], blackColor[2]);
                    doc.text('E-mail:', margin + 120, y + 5);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(textColor[0], textColor[1], textColor[2]);
                    doc.text(cliente.email || 'Não informado', margin + 150, y + 5);

                    // Linha 3: Endereço
                    y += 10;
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(blackColor[0], blackColor[1], blackColor[2]);
                    doc.text('Endereço:', margin + 5, y + 5);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(textColor[0], textColor[1], textColor[2]);
                    const enderecoCompleto = cliente.endereco ?
                        `${cliente.endereco}${cliente.numero ? ', ' + cliente.numero : ''}${cliente.complemento ? ' - ' + cliente.complemento : ''}` :
                        'Não informado';
                    doc.text(enderecoCompleto, margin + 45, y + 5);

                    y += 20;

                    // ===========================================
                    // DADOS DO VEÍCULO
                    // ===========================================

                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(darkGray[0], darkGray[1], darkGray[2]);
                    doc.text('DADOS DO VEÍCULO', margin, y);

                    y += 8;

                    // Caixa com borda para dados do veículo
                    doc.setDrawColor(borderGray[0], borderGray[1], borderGray[2]);
                    doc.rect(margin, y - 3, pageWidth - (2 * margin), 30, 'S');

                    doc.setFontSize(10);

                    // Linha 1: Placa e Marca/Modelo
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(blackColor[0], blackColor[1], blackColor[2]);
                    doc.text('Placa:', margin + 5, y + 5);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(textColor[0], textColor[1], textColor[2]);
                    doc.text(veiculo.placa || 'Não informado', margin + 30, y + 5);

                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(blackColor[0], blackColor[1], blackColor[2]);
                    doc.text('Marca/Modelo:', margin + 100, y + 5);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(textColor[0], textColor[1], textColor[2]);
                    const modeloCompleto = `${veiculo.marca || ''} ${veiculo.modelo || ''}`.trim() || 'Não informado';
                    doc.text(modeloCompleto, margin + 150, y + 5);

                    // Linha 2: Ano, Cor e KM
                    y += 10;
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(blackColor[0], blackColor[1], blackColor[2]);
                    doc.text('Ano:', margin + 5, y + 5);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(textColor[0], textColor[1], textColor[2]);
                    doc.text(veiculo.ano || 'Não informado', margin + 25, y + 5);

                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(blackColor[0], blackColor[1], blackColor[2]);
                    doc.text('Cor:', margin + 80, y + 5);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(textColor[0], textColor[1], textColor[2]);
                    doc.text(veiculo.cor || 'Não informado', margin + 100, y + 5);

                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(blackColor[0], blackColor[1], blackColor[2]);
                    doc.text('KM:', margin + 140, y + 5);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(textColor[0], textColor[1], textColor[2]);
                    doc.text(veiculo.km ? `${veiculo.km} km` : 'Não informado', margin + 160, y + 5);

                    y += 25;

                    // ===========================================
                    // TABELA DE ITENS (PROFISSIONAL)
                    // ===========================================

                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(darkGray[0], darkGray[1], darkGray[2]);
                    doc.text('ITENS DO ORÇAMENTO', margin, y);

                    y += 10;

                    // Cabeçalho da tabela
                    doc.setFillColor(mediumGray[0], mediumGray[1], mediumGray[2]);
                    doc.rect(margin, y - 5, pageWidth - (2 * margin), 8, 'F');

                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(255, 255, 255);

                    // Posicionamento das colunas
                    const colDesc = margin + 5;
                    const colQtd = pageWidth - 100;
                    const colValor = pageWidth - 70;
                    const colTotal = pageWidth - 40;

                    doc.text('Descrição do Serviço / Peça', colDesc, y);
                    doc.text('Qtd', colQtd, y);
                    doc.text('Valor Unit.', colValor, y);
                    doc.text('Total', colTotal, y);

                    y += 8;

                    // Itens da tabela
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(textColor[0], textColor[1], textColor[2]);

                    let totalGeral = 0;

                    if (orc.itens && Array.isArray(orc.itens) && orc.itens.length > 0) {
                        orc.itens.forEach((item, index) => {
                            if (y > 240) {
                                doc.addPage();
                                y = 20;

                                // Recriar cabeçalho na nova página
                                doc.setFillColor(mediumGray[0], mediumGray[1], mediumGray[2]);
                                doc.rect(margin, y - 5, pageWidth - (2 * margin), 8, 'F');

                                doc.setFontSize(9);
                                doc.setFont('helvetica', 'bold');
                                doc.setTextColor(255, 255, 255);
                                doc.text('Descrição do Serviço / Peça', colDesc, y);
                                doc.text('Qtd', colQtd, y);
                                doc.text('Valor Unit.', colValor, y);
                                doc.text('Total', colTotal, y);

                                y += 8;
                                doc.setFont('helvetica', 'normal');
                                doc.setTextColor(textColor[0], textColor[1], textColor[2]);
                            }

                            // Linhas alternadas (zebrado)
                            if (index % 2 === 0) {
                                doc.setFillColor(lightGray[0], lightGray[1], lightGray[2]);
                                doc.rect(margin, y - 4, pageWidth - (2 * margin), 7, 'F');
                            }

                            const descricao = item.descricao || '-';
                            const qtd = item.quantidade || 0;
                            const valorUnit = item.valorUnitario || 0;
                            const total = item.total || 0;
                            totalGeral += total;

                            // Quebrar descrição longa
                            const descLines = doc.splitTextToSize(descricao, 120);
                            doc.text(descLines, colDesc, y);

                            const descHeight = descLines.length * 4;

                            // Alinhar números à direita
                            doc.text(qtd.toString(), colQtd, y + (descHeight / 2) - 2);
                            doc.text(`R$ ${valorUnit.toFixed(2)}`, colValor, y + (descHeight / 2) - 2);
                            doc.text(`R$ ${total.toFixed(2)}`, colTotal, y + (descHeight / 2) - 2);

                            y += Math.max(descHeight, 6) + 2;
                        });
                    } else {
                        doc.text('Nenhum item cadastrado', margin + 5, y);
                        y += 8;
                    }

                    y += 5;

                    // Linha de total
                    doc.setDrawColor(mediumGray[0], mediumGray[1], mediumGray[2]);
                    doc.setLineWidth(0.3);
                    doc.line(pageWidth - 110, y, pageWidth - margin, y);

                    y += 7;

                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(blackColor[0], blackColor[1], blackColor[2]);
                    doc.text('VALOR TOTAL:', pageWidth - 100, y);
                    doc.text(`R$ ${totalGeral.toFixed(2)}`, pageWidth - 40, y, { align: 'right' });

                    y += 15;

                    // ===========================================
                    // OBSERVAÇÕES (se houver)
                    // ===========================================

                    if (orc.observacoes) {
                        if (y > 230) {
                            doc.addPage();
                            y = 20;
                        }

                        doc.setFontSize(12);
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(darkGray[0], darkGray[1], darkGray[2]);
                        doc.text('OBSERVAÇÕES:', margin, y);

                        y += 7;

                        doc.setFontSize(10);
                        doc.setFont('helvetica', 'normal');
                        doc.setTextColor(textColor[0], textColor[1], textColor[2]);

                        const obsLines = doc.splitTextToSize(orc.observacoes, pageWidth - (2 * margin));
                        doc.text(obsLines, margin, y);

                        y += obsLines.length * 5 + 10;
                    }

                    // ===========================================
                    // RODAPÉ PROFISSIONAL
                    // ===========================================

                    // Posicionar no final da página
                    y = pageHeight - 25;

                    doc.setDrawColor(borderGray[0], borderGray[1], borderGray[2]);
                    doc.setLineWidth(0.2);
                    doc.line(margin, y, pageWidth - margin, y);

                    y += 5;

                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(mediumGray[0], mediumGray[1], mediumGray[2]);

                    const dataEmissao = new Date().toLocaleDateString('pt-BR');
                    doc.text(`Documento gerado por AutoFlow em ${dataEmissao}`, pageWidth / 2, y, { align: 'center' });

                    y += 4;
                    doc.text('Orçamento válido por 7 dias. Este documento é uma simulação, sujeito a alterações.', pageWidth / 2, y, { align: 'center' });

                    // Salvar PDF
                    doc.save(`orcamento-${orc.numero || 'sem-numero'}.pdf`);
                    alert('✅ PDF gerado com sucesso!');

                } catch (error) {
                    console.error('Erro detalhado ao gerar PDF:', error);
                    alert('❌ Erro ao gerar PDF: ' + error.message);
                }
            };

            // ===========================================
            // EXCLUIR ORÇAMENTO
            // ===========================================
            window.excluirOrcamento = async function (id) {
                if (!confirm('Excluir este orçamento?')) return;

                const oficinaId = sessionStorage.getItem('oficinaId');

                try {
                    await db.collection('oficinas').doc(oficinaId).collection('orcamentos').doc(id).delete();
                    alert('Orçamento excluído!');
                    carregarOrcamentos();
                } catch (error) {
                    console.error('Erro:', error);
                    alert('Erro ao excluir');
                }
            };

            // ===========================================
            // FILTROS
            // ===========================================
            document.getElementById('search').addEventListener('input', filtrar);
            document.getElementById('filter-status').addEventListener('change', filtrar);

            function filtrar() {
                const termo = document.getElementById('search').value.toLowerCase();
                const status = document.getElementById('filter-status').value;
                const linhas = document.querySelectorAll('#orcamentos-body tr');

                linhas.forEach(linha => {
                    const texto = linha.cells[1]?.textContent.toLowerCase() || '';
                    const statusCelula = linha.cells[5]?.textContent.toLowerCase() || '';

                    const matchBusca = texto.includes(termo);
                    const matchStatus = !status || statusCelula.includes(status);

                    linha.style.display = matchBusca && matchStatus ? '' : 'none';
                });
            }
        });
    </script>
</body>

</html>